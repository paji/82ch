name: YouTube動画文字起こし

on:
  schedule:
    # 1時間ごとに実行
    - cron: '0 * * * *'
  workflow_dispatch:
    # 手動実行用

# リポジトリへの書き込み権限を付与
permissions:
  contents: write

jobs:
  transcribe_video:
    runs-on: ubuntu-latest
    
    steps:
      - name: リポジトリのチェックアウト
        uses: actions/checkout@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: '.'  # リポジトリを現在のディレクトリにチェックアウト
      
      - name: Python環境のセットアップ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: 依存関係のインストール
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib requests youtube-transcript-api
      
      - name: 文字起こしディレクトリの作成
        run: |
          mkdir -p youtube_text
      
      - name: 文字起こしスクリプトの実行
        run: |
          python youtube_transcription.py \
            --livestreams-json livestreams.json \
            --output-dir youtube_text \
            --max-retries 3 \
            --retry-delay 5 \
            --api-delay 10 \
            --progress-file transcription_progress.json
        env:
          YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      
      - name: 変更の確認
        id: check_changes
        run: |
          git status --porcelain
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 変更をコミット
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add youtube_text/ transcription_progress.json
          git commit -m "文字起こしを追加 $(date '+%Y-%m-%d %H:%M')"
      
      - name: 変更をプッシュ
        if: steps.check_changes.outputs.changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
